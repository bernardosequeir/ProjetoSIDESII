CREATE DEFINER=`root`@`localhost` PROCEDURE `AlterarUtilizador`(Mail VARCHAR(100), nPass VARCHAR(10), nMorada varchar(200))
BEGIN
	SELECT user INTO @userId FROM (
		SELECT user, CONCAT(user, '@', host) as userhost FROM mysql.user) base
    WHERE userhost = USER();
	SELECT default_role INTO @role FROM (
        SELECT default_role, CONCAT(user, '@', host) as userhost FROM mysql.user) base
    WHERE userhost = USER();
    IF(CURRENT_ROLE = 'seguranca' OR @role= 'seguranca') THEN 
		IF(Mail = @userID) THEN
            IF(NOT(nPass = 'NULL')) THEN
				UPDATE utilizador
                SET utilizador.Password = nPass  WHERE EmailUtilizador = @userId;
                SET @sql := CONCAT('ALTER USER ','''', Mail,'''','@localhost', ' IDENTIFIED BY ', '''', nPass,'''');
				PREPARE stmt FROM @sql;
				EXECUTE stmt;
			END IF;
            IF(NOT(nMorada = 'NULL')) THEN
				UPDATE utilizador
                SET Morada = nMorada WHERE EmailUtilizador = @userId;
			END IF;
        END IF;
    ELSEIF(CURRENT_ROLE = 'chefe_seguranca' OR @role= 'chefe_seguranca') THEN 
		IF(Mail = @userID) THEN
			IF(NOT(nMorada = 'NULL')) THEN
				UPDATE utilizador
                SET Morada = nNome WHERE nMorada = @userId;
			END IF;
            IF(NOT(nPass = 'NULL')) THEN
                SET @sql := CONCAT('ALTER USER ','''', Mail,'''','@localhost', ' IDENTIFIED BY ', '''', nPass,'''');
				PREPARE stmt FROM @sql;
				EXECUTE stmt;
			END IF;
        ELSE
			SELECT TipoUtilizador FROM utilizador WHERE EmailUtilizador = Mail INTO @Tipppo;
            IF (@Tipppo = 'SEG') THEN
				IF(NOT(nPass = 'NULL')) THEN
					SET @sql := CONCAT('ALTER USER ','''', Mail,'''','@localhost', ' IDENTIFIED BY ', '''', nPass,'''');
					PREPARE stmt FROM @sql;
					EXECUTE stmt;
				END IF;
				IF(NOT(nMorada = 'NULL')) THEN
					UPDATE utilizador
					SET Morada = nMorada WHERE EmailUtilizador = Mail;
				END IF;
			END IF;	
        END IF;
	ELSE 
		IF(NOT(nPass = 'NULL')) THEN
			UPDATE utilizador
			SET utilizador.Password = nPass  WHERE EmailUtilizador = Mail;
			SET @sql := CONCAT('ALTER USER ','''', Mail,'''','@localhost', ' IDENTIFIED BY ', '''', nPass,'''');
			PREPARE stmt FROM @sql;
			EXECUTE stmt;
		END IF;
		IF(NOT(nMorada = 'NULL')) THEN
				UPDATE utilizador
                SET Morada = nMorada WHERE EmailUtilizador = Mail;
		END IF;
        
    END IF;

END